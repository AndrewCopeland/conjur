- !policy
  id: aws
  body:
  - !policy
      id: dev-account
      body:
      - &variables
        - !variable access_key_id
        - !variable secret_access_key
        - !variable region

      - !group secrets-users

      - !permit
        role: !group secrets-users
        privileges: [ read, execute ]
        resources: *variables

- !policy
  id: myapp
  body:
  - !credential-factory
    annotations:
      credential-factory/provider: AWS
      credential-factory/secret_access_key: aws/dev-account/secret_access_key
      credential-factory/policy: |
        {    
          "Version" : "2012-10-17",   
          "Statement" : [
            {
              "Action" : [           
                "sts:GetCallerIdentity"
              ],           
              "Effect" : "Allow",           
              "Resource" : "*"       
            }
          ]
        }

  - !layer

  - !permit
    role: !layer
    privileges: [ read, execute ]
    resources: !credential-factory

- !grant
  role: !group aws/dev-account/secrets-users
  members: !credential-factory myapp

- !host myapp-01.internal

- !grant
  role: !layer myapp
  member: !host myapp-01.internal
