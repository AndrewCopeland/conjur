#!/bin/bash
set -ex

echo "Starting test containers"
echo "---"

docker-compose build
docker-compose up -d conjur-master ldap-server authn-ldap
docker-compose exec conjur-master conjurctl wait

api_key=$(docker-compose exec -T \
  conjur-master conjurctl role retrieve-key cucumber:user:admin | tr -d '\r')

docker-compose run --rm \
  -e CONJUR_AUTHN_API_KEY=$api_key \
  --entrypoint /bin/bash conjur-cli -c "conjur policy load root /var/policy.yml"

echo API KEY: $api_key
